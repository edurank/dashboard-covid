<!-- 

    - Tela para o monitoramento com a c칙mera

-->

<!DOCTYPE html>
<html>
    

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>EPI Vision</title>

    <script>
        function startTime() {
            var today = new Date();
            var h = today.getHours();
            var m = today.getMinutes();
            var s = today.getSeconds();
            m = checkTime(m);
            s = checkTime(s);
            document.getElementById('idHora').innerHTML =
            h + ":" + m + ":" + s;
            var t = setTimeout(startTime, 1000);
        }
        
        
        function checkTime(i) {
            if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
            return i;
        }


        function registrarAviso() {
            //alert("teste");
        }
 </script>

    <style>
        #webcam-camera {
            margin-left: 20px;
        }

        #comsemMask {
            color:white;
            font-size: 50px;
        }

        #idHora {
            color: white;
            font-size: 50px;
        }

        th {
            color:white;
            font-size: 20px;
        }

        td {
            color:white;
            font-size: 20px;
        }

        div {
            /*border: green;
            border-style: solid;*/
        }

    </style>
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>

    <script type="text/javascript">
        const URL = "https://teachablemachine.withgoogle.com/models/ZTFzIfo4P/";

        // meu antigo"https://teachablemachine.withgoogle.com/models/PI5WkIKYD/"
        //https://teachablemachine.withgoogle.com/models/ZTFzIfo4P/

        let model, webcam, labelContainer, maxPredictions, tempo;

        let comMask = "Sem mascara";
        let semMask = "Com mascara";
        
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(1152, 720, flip);

            
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);

            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) { // and class labels
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update(); // update the webcam frame
            await predict();
            window.requestAnimationFrame(loop);
        }


        async function camStop() {
            await webcam.stop();
            var list =  document.getElementById("webcam-container");
            list.removeChild(list.childNodes[0]);
            
        }



        async function predict() {
            
            const prediction = await model.predict(webcam.canvas);

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                    
                if(prediction[i].className == semMask && prediction[i].probability.toFixed(2) >= 0.80){
                    tempo = setTimeout(function(){
                        registrarAviso();
                    }, 3000);
                    $(document).ready(function() {
                        $("#comsemMask").css("background-color","#a60013");
                        $('#comsemMask').text('Sem m치scara');
                    });
                } else if(prediction[i].className == comMask && prediction[i].probability.toFixed(2) >= 0.80){
                    clearTimeout(tempo);
                    $(document).ready(function() {
                        $("#comsemMask").css("background-color","blue");
                        $('#comsemMask').text('Com m치scara');
                    });
                } else if(prediction[i].className == "nao-detectado" && prediction[i].probability.toFixed(2) >= 0.80){
                    clearTimeout(tempo);
                    $(document).ready(function() {
                        $("#comsemMask").css("background-color","blue");
                        $('#comsemMask').text('Nada detectado');
                    });
                }
            }
        }
    </script>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>


    <!-- Custom fonts for this template-->
    <link href="./vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet"
    >
    
    <link rel="shortcut icon" href="./vendor/fontawesome-free/svgs/solid/eye.svg">
    <link rel="shortcut icon" href="./vendor/fontawesome-free/svgs/solid/address-book.svg">
 
    <!-- Custom styles for this template-->
    <link href="./css/sb-admin-2.css" rel="stylesheet">

</head>
<body onload="startTime()">
    <div id="wrapper">
        <!-- Sidebar -->
        <%- include('../partials/sidebar'); %>
        <div id="content-wrapper">
            <!-- Main Content -->
            <div id="content">
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- Content Row -->
                    <div class="row">
                        <div class="card shadow mb-4">
                            <h4 class="m-0 font-weight-bold text-light">Monitoramento</h4>
                        </div>
                    </div> <!-- row -->
                    <div class="row">
                        <button onclick="init()">Iniciar</button>
                        <button onclick="camStop()">Parar</button>
                    </div>

                    <div class="row card shadow mb-4">
                        <!--  SCRIPT TEACHABLE MACHINE -->
                        <div id="webcam-container" style="height:730px;width:1162px;border-color: white;border-style: solid;"></div>
                    </div> 
                    </br>
                    <table style="border: 1px solid white">
                        <tr>
                            <th>Status</th>
                            <th>Hor치rio</th>
                            <th>Local</th>
                        </tr>
                        <tr>
                            <td id="comsemMask"></td>
                            <td id="idHora"></td>
                            <td>Quarto</td>
                        </tr>
                    </table>
                    <script></script>
                    </div> <!-- /.row -->
                </div> <!-- /.container-fluid -->
            </div> <!-- content -->
        </div> <!-- content-wrapper -->
    </div> <!-- wrapper -->

    <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

</body>
</html>